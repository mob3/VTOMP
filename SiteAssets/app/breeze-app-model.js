'use strict';

define(["jquery", "./fieldDict", "breeze", "breeze.labs.dataservice.abstractrest"
, "./vtomp.breeze.labs.dataservice.sharepoint", "breeze.metadata-helper"
], function(jQuery, appDict, breeze) {
var metadataStore;
var vehicleType;
var contractType;
//var companyType;
var entityManager;

//jQuery(document).ready(function () {
  // STEP 1: configure breeze
  configureBreeze();

  // STEP 2: define the metadata for the entity
  createMetadata();

  // STEP 3: init breeze
  initBreeze();

  // enable the buttons
  //jQuery('input[type="button"]').removeAttr('disabled');
//});

// configure breeze
function configureBreeze() {
  // configure breeze to use SharePoint OData service
  var dsAdapter = breeze.config.initializeAdapterInstance('dataService', 'SharePointOData', true);

  // tell breeze how to get the security validation token for 
  //  HTTP POST & DELETE calls
  dsAdapter.getRequestDigest = function () {
    return jQuery('#__REQUESTDIGEST').val();
  };
}

// create the metadata for the rest endpoint
function createMetadata() {
  // create a new breeze metadata store
  metadataStore = new breeze.MetadataStore();

  // setup a helper to create entities
  var namespace = '';
  var helper = new breeze.config.MetadataHelper(namespace, breeze.AutoGeneratedKeyType.Identity);
  // define a new function that uses the helper to
  //  1) create a new entity type in the metadata store
  //  2) create a default select so we don't have to create the
  //    OData $select each time
  var addType = function (typeDef) {
    var entityType = helper.addTypeToStore(metadataStore, typeDef);
    _addDefaultSelect(entityType);
    return entityType;
  };

  // create entity for contacts
  addType({
    name: appDict.listDict["Vehicles"],
    defaultResourceName: 'getbytitle(\'' + appDict.listDict["Vehicles"] + '\')/items',
    dataProperties: {
      Id: { type: breeze.DataType.Int32, isPartOfKey: true },
      Title: { nullable: false }//,  // this is actually the last name field in the list
	  , Created: { type: breeze.DataType.DateTime }
	  , Modified: { type: breeze.DataType.DateTime }

   
    }
  });

	var addTypeDataProperties = {
      Id: { type: breeze.DataType.Int32 },
      Title: { nullable: false }//,  // this is actually the last name field in the list
	  , Description: { nullable: false }
	  , Customer: { nullable: false }
	  , Created: { nullable: false }
    }
    addTypeDataProperties[ appDict.fieldDict["DueDate"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["SolicitationNumber"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["CustomerAgencyShort"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["PartnerResponseNeededBy"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["ReferenceNumber"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["PreStatus"] ] = {  };
    addTypeDataProperties[ appDict.fieldDict["EmailToTeam"] ] = {  };
    addTypeDataProperties[ appDict.fieldDict["EmailNote"] ] = {  };
    addTypeDataProperties[ appDict.fieldDict["TrackingStatus"] ] = {  };
    addTypeDataProperties[ appDict.fieldDict["TeamingStatus"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["TypeofSolicitation"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["ProjectStart"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["ProjectEnd"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["PeriodofPerformance"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["PlaceofPerformance"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["LOEEstimate"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["IncumbentContractors"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["DateReleased"] ] = { nullable: false };
    addTypeDataProperties[ appDict.fieldDict["ClearanceRequirement"] ] = { nullable: false };
	addTypeDataProperties[ "V_x002d_ID" ] = { nullable: false };
  // create entity for contacts
  addType({
    name: appDict.listDict["Contracts"],
    defaultResourceName: 'getbytitle(\'' + appDict.listDict["Contracts"] +'\')/items',
    dataProperties: addTypeDataProperties 
  });

	var addCompaniesTypeDataProperties = {
      Id: { type: breeze.DataType.Int32, isPartOfKey: true },
      Title: { nullable: false }//,  // this is actually the last name field in the list
	  , Created: { type: breeze.DataType.DateTime }
   }
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["ShortTitle"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["BusinessSize"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["CAGE"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["Certifications"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["ContractorLevel"] ] = { nullable: false };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["CorporateAchievements"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["DemonstratedCapabilities"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["DHSComponentExperience"] ] = {  hasMany: true };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["DUNS"] ] = { nullable: false };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["FacilityClearanceLevel"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["HeadquartersLocation"] ] = { };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["RelevantExperience"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["SocioeconomicDisadvantagedDesignation"] ] = {  };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["TechnologyPartnerships"] ] = { };
    addCompaniesTypeDataProperties[ appDict.companyFieldsDict["Website"] ] = { complexTypeName: "UrlInfo", isNullable: false };

  addType({
    name: "Companies",
    defaultResourceName: 'getbytitle(\'Companies\')/items',
    dataProperties: addCompaniesTypeDataProperties
  
          });

  addType({
    shortName: "UrlInfo",
    isComplexType: true,
    dataProperties: {
            Description:    { maxLength: 600 },
            Url:       { maxLength: 2000 }
             }
   });


	var addProfilesTypeDataProperties = {
      Id: { type: breeze.DataType.Int32, isPartOfKey: true },
      Title: { }
	  , Created: { type: breeze.DataType.DateTime }
	  , Modified: { type: breeze.DataType.DateTime }
   }
    addProfilesTypeDataProperties [ appDict.fieldDict["Name"] ] = { nullable: false };
    addProfilesTypeDataProperties [ appDict.fieldDict["WorkPhone"] ] = {  };
    addProfilesTypeDataProperties [ appDict.fieldDict["Email"] ] = {  };
    addProfilesTypeDataProperties [ appDict.fieldDict["MobilePhone"] ] = {  };
    addProfilesTypeDataProperties [ appDict.fieldDict["EmailOpportunityUpdates"] ] = {  };

  addType({
    name: "Profiles",
    defaultResourceName: 'getbytitle(\'' + appDict.listDict["Profiles"] +'\')/items',
    dataProperties: addProfilesTypeDataProperties 
  
          });



  // add 'defaultSelect' custom metadata that selects for all mapped data properties
  // could be used by SharePoint dataservice adapter to exclude unwanted property data
  // in query payload
  function _addDefaultSelect(type) {
    var custom = type.custom;
    // bail out if defined by hand already
    if (custom && custom.defaultSelect != null) { return; }

    var select = [];
    type.dataProperties.forEach(function (prop) {
      if (!prop.isUnmapped) { select.push(prop.name); }
    });
    if (select.length) {
      if (!custom) { type.custom = custom = {}; }
      custom.defaultSelect = select.join(',');
    }
    return type;
  }

}

// init breeze for queries
function initBreeze() {
  // get reference to contact entity type
  vehicleType = metadataStore.getEntityType(appDict.listDict["Vehicles"]);
  contractType = metadataStore.getEntityType(appDict.listDict["Contracts"]);

  // create the data service
  var dataService = new breeze.DataService({
    // tell breeze the root REST endpoint to use
    //  since we only are using lists, point to that
    serviceName: _spPageContextInfo.webAbsoluteUrl + '/_api/web/lists/',
    // tell breeze not to interrogate sharepoint for it's
    //  massive OData $metadata response... we created it manually
    hasServerMetadata: false
  });

  // create an instance of the entity manager
  entityManager = new breeze.EntityManager({
    dataService: dataService,
    // tell breeze where the metadata is
    metadataStore: metadataStore
  });
}

// get all items from sharepoint REST API
function getAllItems() {
  breeze.EntityQuery
    .from(vehicleType.defaultResourceName)
    .using(entityManager)
    .execute()
    .then(function (response) {
      var results = response.results;
      // write results > div
      if (results && results.length) {
        var message = '';
        for (var index = 0; index < results.length; index++) {
          message +=  results[index].Title() + ' ()<br/>';
        }
        jQuery("#results").html(message);
      }
    });
  return false;
}

// get a single item
function getOneItem() {
  // try to get a single item from the cache, then revert to server
  entityManager.fetchEntityByKey('Vehicles', 1, true)
  .then(function (data) {
    var message =  data.entity.Title() + ' ()<br/>';
    message += 'pulled from: ' + (data.fromCache ? 'cache' : 'server');
    jQuery("#results").html(message);
  });
}

// update an item
function updateFirstItem() {
  // get the first item
  var promise = entityManager.fetchEntityByKey('Vehicles', 1, true)
                  .then(function (data) {
                    return data.entity;
                  });
  // update the first item
  promise.then(function (contact) {
    contact.Title('NewNamen');
    entityManager.saveChanges().then(function () {
      jQuery("#results").html('saved first item in list');
    });
  });
}

// update an item
function updateContract(contractId, contractTitle) {
  // get the first item
  var promise = entityManager.fetchEntityByKey(appDict.listDict["Contracts"], contractId, true)
                  .then(function (data) {
                    return data.entity;
                  });
  // update the first item
  promise.then(function (contact) {
    contact.Title(contractTitle);
    entityManager.saveChanges().then(function (saveResult) {
		var savedEntities = saveResult.entities;
		var keyMappings = saveResult.keyMappings;	
      jQuery("#results").html('saved first item in list');
    }).fail(function (e) {
    // e is any exception that was thrown.
		jQuery("#results").html('error' + e);
	});
  });
}

// create a new contact
function createItem() {
  // create entity
  var contact = entityManager.createEntity(vehicleType);
 // contact.FirstName = 'Lewis';
  contact.Title('Hamilton');
//  contact.Email = 'lewis.hamilton@mercedes.com';
  // save entity
  entityManager.saveChanges()
    .then(function () {
      jQuery("#results").html('new item created');
    });
}

// deletes the last item in the list
function deleteItem() {
  // delete the last item in the list
  breeze.EntityQuery
    .from(vehicleType.defaultResourceName)
    .using(entityManager)
    .execute()
    .then(function (response) {
      var results = response.results;
      var lastContact = results[results.length - 1];
      lastContact.entityAspect.setDeleted();
      entityManager.saveChanges()
        .then(function () {
          jQuery("#results").html('last item in list deleted');
        });
    });
}
	return entityManager;
});